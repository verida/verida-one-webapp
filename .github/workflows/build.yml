name: Build

on:
  workflow_dispatch:
    inputs:
      save-build:
        description: 'Save build as artifact'
        required: false
        type: boolean
  push:
    branches-ignore:
      - "main" # the deploy workflow already build and test on every push to main
  pull_request:
    branches:
      - "**"

# This allows a subsequently queued workflow run to interrupt previous runs
concurrency:
  group: '${{ github.workflow }}-${{ github.ref }}'
  cancel-in-progress: true

jobs:
  build:
    name: Build and test frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2.5.0

      - name: Define node version
        run: echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_ENV

      - name: Set up node
        uses: actions/setup-node@v3.5.1
        with:
          node-version: '${{ env.NODE_VERSION }}'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Test frontend
        run: yarn run test

      - name: Build frontend
        run: yarn run build

      - name: Upload build artifacts
        if:  ${{ inputs.save-build }}
        uses: actions/upload-artifact@v3.1.2
        with:
          name: build
          path: build
